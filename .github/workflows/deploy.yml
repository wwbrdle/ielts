name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build application
      run: npm run build
        
    - name: Create deployment package
      run: |
        tar -czf build.tar.gz build/
        
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "SSH key length: ${#ORACLE_SSH_KEY}"
        
        # SSH í‚¤ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if [ -z "${{ secrets.ORACLE_SSH_KEY }}" ]; then
          echo "ERROR: ORACLE_SSH_KEY is empty!"
          exit 1
        fi
        
        # SSH í‚¤ ë‚´ìš© í™•ì¸ (ì²˜ìŒê³¼ ë ë¶€ë¶„ë§Œ)
        echo "SSH key starts with: $(echo "${{ secrets.ORACLE_SSH_KEY }}" | head -c 50)"
        echo "SSH key ends with: $(echo "${{ secrets.ORACLE_SSH_KEY }}" | tail -c 50)"
        
        echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # SSH í‚¤ íŒŒì¼ ë‚´ìš© í™•ì¸
        echo "SSH key file content (first 100 chars):"
        head -c 100 ~/.ssh/id_rsa
        
        ls -la ~/.ssh/
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        echo "Running ssh-keyscan..."
        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
        echo "SSH setup completed"
        
        # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
        echo "Testing SSH connection..."
        ssh -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.ORACLE_USERNAME }}@${{ secrets.ORACLE_HOST }} "echo 'SSH connection successful'"
        echo "SSH test completed"
        
    - name: Copy files to server
      run: |
        scp -P ${{ secrets.ORACLE_PORT }} build.tar.gz ${{ secrets.ORACLE_USERNAME }}@${{ secrets.ORACLE_HOST }}:/tmp/
        
    - name: Extract and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USERNAME }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        port: ${{ secrets.ORACLE_PORT }}
        script: |
          # React ì•± ë°°í¬
          echo "Deploying React app..."
          
          # ê° ë‹¨ê³„ë³„ ìƒì„¸ ë¡œê·¸
          echo "Step 1: Creating app directory..."
          sudo mkdir -p /var/www/ielts-app
          sudo chown -R opc:opc /var/www/ielts-app
          echo "Directory created: $(ls -la /var/www/ielts-app/)"
          
          # ì•± ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/ielts-app
          echo "Current directory: $(pwd)"
          
          # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
          echo "Step 2: Backing up existing files..."
          sudo cp -r build build.backup.$(date +%Y%m%d_%H%M%S) || echo "No existing build to backup"
          
          # ìƒˆ ë¹Œë“œ íŒŒì¼ ì••ì¶• í•´ì œ
          echo "Step 3: Extracting new build files..."
          sudo rm -rf build
          sudo mkdir -p build
          echo "Build directory created: $(ls -la build/)"
          
          echo "Extracting build.tar.gz..."
          sudo tar -xzf /tmp/build.tar.gz -C /var/www/ielts-app/
          echo "Extraction completed. Build contents: $(ls -la build/)"
          sudo rm /tmp/build.tar.gz
          
          # ê¶Œí•œ ì„¤ì •
          echo "Step 4: Setting permissions..."
          sudo chown -R opc:opc /var/www/ielts-app/build
          sudo chmod -R 755 /var/www/ielts-app/build
          echo "Permissions set: $(ls -la build/)"
          
          # ì›¹ì„œë²„ ìë™ ì‹¤í–‰
          echo "ğŸš€ Starting web server automatically..."
          
          # ê¸°ì¡´ ì›¹ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "Stopping existing web server processes..."
          sudo pkill -f "python3 -m http.server" || echo "No existing processes to stop"
          sleep 2
          
          # ì›¹ì„œë²„ ì‹œì‘
          echo "Starting new web server on port 8080..."
          cd /var/www/ielts-app
          
          # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì›¹ì„œë²„ ì‹¤í–‰
          nohup python3 -m http.server 8080 --directory build > web_server.log 2>&1 &
          WEB_SERVER_PID=$!
          
          # ì›¹ì„œë²„ ì‹œì‘ í™•ì¸
          echo "Waiting for web server to start..."
          sleep 3
          
          # í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
          if ps -p $WEB_SERVER_PID > /dev/null; then
            echo "âœ… Web server started successfully with PID: $WEB_SERVER_PID"
            
            # í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸
            if netstat -tlnp 2>/dev/null | grep ":8080" > /dev/null; then
              echo "âœ… Port 8080 is listening"
              echo "ğŸŒ React app is now accessible at: http://$(curl -s ifconfig.me):8080"
            else
              echo "âš ï¸ Web server process is running but port 8080 is not listening yet"
              echo "Waiting a bit more..."
              sleep 2
              if netstat -tlnp 2>/dev/null | grep ":8080" > /dev/null; then
                echo "âœ… Port 8080 is now listening"
                echo "ğŸŒ React app is accessible at: http://$(curl -s ifconfig.me):8080"
              else
                echo "âŒ Port 8080 is still not listening"
                echo "Web server log:"
                tail -10 web_server.log
              fi
            fi
          else
            echo "âŒ Failed to start web server"
            echo "Web server log:"
            cat web_server.log
            echo "Process status:"
            ps aux | grep python3
            exit 1
          fi
          
          echo "ğŸ‰ React app deployed and web server started successfully!"
          echo "ğŸ“ Files are available at: /var/www/ielts-app/build"
          echo "ğŸš€ Web server is running on port 8080"
          echo "ğŸŒ Access your app at: http://$(curl -s ifconfig.me):8080"
